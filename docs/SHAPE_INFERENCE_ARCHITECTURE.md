# Shape æ¨æ–­ç³»ç»Ÿæ¶æ„

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Mini-Infer Engine                        â”‚
â”‚                     (TensorRT-style)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ build()
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Build Pipeline                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Step 1: Graph Optimization                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ - Auto load registered passes             â”‚             â”‚
â”‚  â”‚ - Conv+ReLU fusion                        â”‚             â”‚
â”‚  â”‚ - Dead code elimination                   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                     â”‚                                       â”‚
â”‚                     â–¼                                       â”‚
â”‚  Step 2: Topological Sort                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ - Ensure execution order                  â”‚             â”‚
â”‚  â”‚ - Detect cycles                           â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                     â”‚                                       â”‚
â”‚                     â–¼                                       â”‚
â”‚  Step 3: Shape Inference â­ (THIS DOCUMENT)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚             â”‚
â”‚  â”‚ â”‚ For each node (topological order):  â”‚   â”‚             â”‚
â”‚  â”‚ â”‚                                     â”‚   â”‚             â”‚
â”‚  â”‚ â”‚ 1. Collect input shapes             â”‚   â”‚             â”‚
â”‚  â”‚ â”‚    - From graph connections         â”‚   â”‚             â”‚
â”‚  â”‚ â”‚    - From input_tensors (weights)   â”‚   â”‚             â”‚
â”‚  â”‚ â”‚                                     â”‚   â”‚             â”‚
â”‚  â”‚ â”‚ 2. Call operator->infer_shape()     â”‚   â”‚             â”‚
â”‚  â”‚ â”‚                                     â”‚   â”‚             â”‚
â”‚  â”‚ â”‚ 3. Create output tensors            â”‚   â”‚             â”‚
â”‚  â”‚ â”‚    with inferred shapes             â”‚   â”‚             â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                     â”‚                                       â”‚
â”‚                     â–¼                                       â”‚
â”‚  Step 4: Memory Planning                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ - Liveness analysis (uses shapes!)        â”‚             â”‚
â”‚  â”‚ - Interference graph                      â”‚             â”‚
â”‚  â”‚ - Greedy coloring allocation              â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                     â”‚                                       â”‚
â”‚                     â–¼                                       â”‚
â”‚  Step 5: Tensor Allocation                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ - Allocate according to memory plan       â”‚             â”‚
â”‚  â”‚ - Skip already allocated                  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Ready Engine â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Shape æ¨æ–­è¯¦ç»†æµç¨‹

### è¾“å…¥æ¥æº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Graph Structure                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  Input Nodes (from ONNX or manual)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ input: Tensor([1, 3, 224, 224]) â”‚     â”‚ â† Must have shape!
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚           â”‚                                â”‚
â”‚           â”‚ graph->connect()               â”‚
â”‚           â–¼                                â”‚
â”‚  Operator Nodes                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ conv1: Conv2D                    â”‚     â”‚
â”‚  â”‚  - Operator: Conv2D              â”‚     â”‚
â”‚  â”‚  - Weights: [64,3,7,7] â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚     â”‚ â† Must have shape!
â”‚  â”‚  - Bias: [64]                   â”‚â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚     â”‚
â”‚           â”‚                          â”‚     â”‚
â”‚           â”‚                          â”‚     â”‚
â”‚           â–¼                          â”‚     â”‚
â”‚  infer_shape([1,3,224,224])         â”‚     â”‚
â”‚      + weight shape [64,3,7,7]      â”‚     â”‚
â”‚      â†“                               â”‚     â”‚
â”‚  Output: [1, 64, 112, 112] âœ…       â”‚     â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç®—å­å½¢çŠ¶æ¨æ–­

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Operator::infer_shape()                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Conv2D                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Input:  [N, C_in, H_in, W_in]              â”‚           â”‚
â”‚  â”‚ Weight: [C_out, C_in, K_h, K_w]            â”‚           â”‚
â”‚  â”‚                                             â”‚           â”‚
â”‚  â”‚ H_out = (H_in + 2*P_h - K_h) / S_h + 1    â”‚           â”‚
â”‚  â”‚ W_out = (W_in + 2*P_w - K_w) / S_w + 1    â”‚           â”‚
â”‚  â”‚                                             â”‚           â”‚
â”‚  â”‚ Output: [N, C_out, H_out, W_out]           â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                             â”‚
â”‚  Pooling (Max/Avg)                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Input:  [N, C, H_in, W_in]                 â”‚           â”‚
â”‚  â”‚                                             â”‚           â”‚
â”‚  â”‚ H_out = (H_in + 2*P_h - K_h) / S_h + 1    â”‚           â”‚
â”‚  â”‚ W_out = (W_in + 2*P_w - K_w) / S_w + 1    â”‚           â”‚
â”‚  â”‚                                             â”‚           â”‚
â”‚  â”‚ Output: [N, C, H_out, W_out]               â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                             â”‚
â”‚  Linear                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Input:  [..., in_features]                 â”‚           â”‚
â”‚  â”‚ Weight: [out_features, in_features]        â”‚           â”‚
â”‚  â”‚                                             â”‚           â”‚
â”‚  â”‚ Output: [..., out_features]                â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                             â”‚
â”‚  ReLU / Activation                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Input:  [...]                               â”‚           â”‚
â”‚  â”‚ Output: [...] (same shape)                 â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                             â”‚
â”‚  Flatten                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Input:  [N, C, H, W]                       â”‚           â”‚
â”‚  â”‚ Axis:   1                                   â”‚           â”‚
â”‚  â”‚                                             â”‚           â”‚
â”‚  â”‚ Output: [N, C*H*W]                         â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› é—®é¢˜ä¸è§£å†³

### é—®é¢˜ï¼šTensor::reshape() é™åˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Tensor Lifecycle                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  âŒ é”™è¯¯æ–¹å¼ (Old)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 1. Create empty tensor                       â”‚     â”‚
â”‚  â”‚    auto t = make_shared<Tensor>();           â”‚     â”‚
â”‚  â”‚    â†’ shape = [], numel = 0                   â”‚     â”‚
â”‚  â”‚                                               â”‚     â”‚
â”‚  â”‚ 2. Try to reshape                             â”‚     â”‚
â”‚  â”‚    t->reshape(Shape({1,3,224,224}));         â”‚     â”‚
â”‚  â”‚    â†’ Check: numel(0) != numel(150528)        â”‚     â”‚
â”‚  â”‚    â†’ RETURN (failed!) âŒ                     â”‚     â”‚
â”‚  â”‚                                               â”‚     â”‚
â”‚  â”‚ 3. Shape still empty                          â”‚     â”‚
â”‚  â”‚    â†’ shape = [], numel = 0                   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                        â”‚
â”‚  âœ… æ­£ç¡®æ–¹å¼ (Fixed)                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 1. Create with shape                          â”‚     â”‚
â”‚  â”‚    auto t = make_shared<Tensor>(              â”‚     â”‚
â”‚  â”‚        Shape({1,3,224,224}),                  â”‚     â”‚
â”‚  â”‚        DataType::FLOAT32                      â”‚     â”‚
â”‚  â”‚    );                                         â”‚     â”‚
â”‚  â”‚    â†’ shape = [1,3,224,224], numel = 150528   â”‚     â”‚
â”‚  â”‚    â†’ data allocated âœ…                        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è§£å†³æ–¹æ¡ˆå¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Solution Comparison                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  æ–¹æ¡ˆ 1: åˆ›å»ºæ—¶æŒ‡å®šå½¢çŠ¶ (Current) âœ…                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ auto t = make_shared<Tensor>(               â”‚           â”‚
â”‚  â”‚     Shape({1,3,224,224}),                   â”‚           â”‚
â”‚  â”‚     DataType::FLOAT32                       â”‚           â”‚
â”‚  â”‚ );                                          â”‚           â”‚
â”‚  â”‚                                             â”‚           â”‚
â”‚  â”‚ Pros: âœ… Simple, always works               â”‚           â”‚
â”‚  â”‚ Cons: âš ï¸ Allocates memory immediately       â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                             â”‚
â”‚  æ–¹æ¡ˆ 2: æ·»åŠ  set_shape() (Future)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ auto t = make_shared<Tensor>();             â”‚           â”‚
â”‚  â”‚ t->set_shape(Shape({1,3,224,224}));        â”‚           â”‚
â”‚  â”‚ // Allocate later                            â”‚           â”‚
â”‚  â”‚ t->allocate();                               â”‚           â”‚
â”‚  â”‚                                             â”‚           â”‚
â”‚  â”‚ Pros: âœ… Deferred allocation                â”‚           â”‚
â”‚  â”‚       âœ… More flexible                       â”‚           â”‚
â”‚  â”‚ Cons: âš ï¸ Needs API change                   â”‚           â”‚
â”‚  â”‚       âš ï¸ Risk of shape/data mismatch        â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ•°æ®æµç¤ºä¾‹

### LeNet-5 Shape æ¨æ–­è¿‡ç¨‹

```
Input: [1, 1, 28, 28]
  â”‚
  â”œâ”€ Conv2D (32 filters, 5x5, stride=1, padding=2)
  â”‚   Input:  [1, 1, 28, 28]
  â”‚   Weight: [32, 1, 5, 5]
  â”‚   H_out = (28 + 2*2 - 5) / 1 + 1 = 28
  â”‚   W_out = (28 + 2*2 - 5) / 1 + 1 = 28
  â”‚   â†“
  â”‚   Output: [1, 32, 28, 28] âœ…
  â”‚
  â”œâ”€ ReLU
  â”‚   Input:  [1, 32, 28, 28]
  â”‚   â†“
  â”‚   Output: [1, 32, 28, 28] âœ… (same shape)
  â”‚
  â”œâ”€ MaxPool2D (2x2, stride=2, padding=0)
  â”‚   Input:  [1, 32, 28, 28]
  â”‚   H_out = (28 + 2*0 - 2) / 2 + 1 = 14
  â”‚   W_out = (28 + 2*0 - 2) / 2 + 1 = 14
  â”‚   â†“
  â”‚   Output: [1, 32, 14, 14] âœ…
  â”‚
  â”œâ”€ Flatten (axis=1)
  â”‚   Input:  [1, 32, 14, 14]
  â”‚   numel = 32 * 14 * 14 = 6272
  â”‚   â†“
  â”‚   Output: [1, 6272] âœ…
  â”‚
  â””â”€ Linear (10 classes)
      Input:  [1, 6272]
      Weight: [10, 6272]
      â†“
      Output: [1, 10] âœ…

Memory Statistics:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Conv output:   [1,32,28,28] = 25,088 bytes
ReLU output:   [1,32,28,28] = 25,088 bytes
Pool output:   [1,32,14,14] =  6,272 bytes
Flatten output:[1,6272]     =  6,272 bytes
Linear output: [1,10]       =     40 bytes
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Original:  62,760 bytes = 61.29 KB
After optimization (memory reuse): ~31 KB
Memory saving: ~49%
```

---

## ğŸ”— ä¸å…¶ä»–æ¨¡å—çš„é›†æˆ

### 1. ONNX Importer â†’ Shape Inference

```
ONNX Model (.onnx)
  â”‚
  â”œâ”€ Parse ValueInfoProto
  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   â”‚ input {                      â”‚
  â”‚   â”‚   name: "input"              â”‚
  â”‚   â”‚   type {                     â”‚
  â”‚   â”‚     tensor_type {            â”‚
  â”‚   â”‚       elem_type: FLOAT       â”‚
  â”‚   â”‚       shape {                â”‚
  â”‚   â”‚         dim { dim_value: 1 } â”‚ â† Parse this
  â”‚   â”‚         dim { dim_value: 3 } â”‚
  â”‚   â”‚         dim { dim_value: 224}â”‚
  â”‚   â”‚         dim { dim_value: 224}â”‚
  â”‚   â”‚       }                      â”‚
  â”‚   â”‚     }                        â”‚
  â”‚   â”‚   }                          â”‚
  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â”œâ”€ Create Tensor with Shape
  â”‚   auto tensor = make_shared<Tensor>(
  â”‚       Shape({1, 3, 224, 224}),
  â”‚       DataType::FLOAT32
  â”‚   );
  â”‚
  â””â”€ Engine::build() â†’ infer_shapes()
      â†’ Propagate shapes through graph âœ…
```

### 2. Shape Inference â†’ Memory Planning

```
Shape Inference Result
  â”‚
  â”œâ”€ Each tensor has shape
  â”‚   conv1:   [1, 64, 112, 112] â†’ 50,176 bytes
  â”‚   relu1:   [1, 64, 112, 112] â†’ 50,176 bytes
  â”‚   pool1:   [1, 64, 56, 56]   â†’ 12,544 bytes
  â”‚
  â”œâ”€ Memory Planning uses sizes
  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   â”‚ Liveness Analysis              â”‚
  â”‚   â”‚  - conv1: birth=1, death=2     â”‚
  â”‚   â”‚           size=50,176 bytes âœ… â”‚
  â”‚   â”‚  - relu1: birth=2, death=3     â”‚
  â”‚   â”‚           size=50,176 bytes âœ… â”‚
  â”‚   â”‚  - pool1: birth=3, death=4     â”‚
  â”‚   â”‚           size=12,544 bytes âœ… â”‚
  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â””â”€ Accurate Memory Statistics
      Original:  112 KB
      Optimized:  62 KB
      Saving:     44% âœ…
```

---

## ğŸ¯ è®¾è®¡åŸåˆ™

### TensorRT-style Design

1. **Build é˜¶æ®µå®Œæˆé™æ€åˆ†æ**
   - Shape æ¨æ–­
   - å†…å­˜è§„åˆ’
   - å›¾ä¼˜åŒ–

2. **Forward é˜¶æ®µåªæ‰§è¡Œ**
   - ä¸æ¨æ–­å½¢çŠ¶
   - ä¸åˆ†é…å†…å­˜
   - æœ€å°å¼€é”€

3. **åˆ†ç¦»å…³æ³¨ç‚¹**
   - ç®—å­å®ç° `infer_shape()`
   - Engine åè°ƒæ•´ä½“æµç¨‹
   - ç”¨æˆ·åªè°ƒç”¨ `build()` å’Œ `forward()`

### Error Handling

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Error Detection Points             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  1. Build Phase                        â”‚
â”‚     âœ… Shape mismatch                  â”‚
â”‚     âœ… Missing input shapes            â”‚
â”‚     âœ… Invalid parameters              â”‚
â”‚                                        â”‚
â”‚  2. Forward Phase                      â”‚
â”‚     âœ… Input shape validation          â”‚
â”‚     âœ… Runtime errors                  â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç”¨æˆ·æŒ‡å—](SHAPE_INFERENCE.md)
- [å¿«é€Ÿå‚è€ƒ](QUICK_REFERENCE_SHAPE_INFERENCE.md)
- [Tensor reshape é—®é¢˜](TENSOR_RESHAPE_ISSUE.md)
- [ä¿®å¤æ€»ç»“](../SHAPE_INFERENCE_FIX_SUMMARY.md)
- [å½“å‰çŠ¶æ€](../SHAPE_INFERENCE_STATUS.md)

---

## âœ… æ€»ç»“

**Shape æ¨æ–­ç³»ç»Ÿæ˜¯ Mini-Infer çš„æ ¸å¿ƒåŸºç¡€**ï¼Œç¡®ä¿ï¼š

1. âœ… æ‰€æœ‰ tensor å½¢çŠ¶åœ¨ build é˜¶æ®µç¡®å®š
2. âœ… å†…å­˜ç»Ÿè®¡å‡†ç¡®å¯é 
3. âœ… æå‰æ£€æµ‹é”™è¯¯
4. âœ… ä¼˜åŒ–å†…å­˜ä½¿ç”¨
5. âœ… ç¬¦åˆ TensorRT è®¾è®¡ç†å¿µ

è¿™æ˜¯ä¸€ä¸ª**ç”Ÿäº§çº§è´¨é‡**çš„å®ç°ï¼ğŸ‰

