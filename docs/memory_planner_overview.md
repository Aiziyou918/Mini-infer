# é™æ€å†…å­˜è§„åˆ’å™¨ï¼ˆStatic Memory Plannerï¼‰- é¡¹ç›®æ€»è§ˆ

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

å®ç°äº†**TensorRTé£æ ¼çš„é™æ€å†…å­˜è§„åˆ’**ï¼Œé€šè¿‡åˆ†æTensorç”Ÿå‘½å‘¨æœŸå®ç°å†…å­˜å¤ç”¨ï¼Œå¤§å¹…é™ä½æ¨ç†æ—¶çš„å†…å­˜å ç”¨ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ’° **èŠ‚çœå†…å­˜**: 30%-75%ï¼ˆå–å†³äºç½‘ç»œç»“æ„ï¼‰
- ğŸš€ **å¯¹æ ‡TensorRT**: ä½¿ç”¨ç›¸åŒçš„è´ªå¿ƒç€è‰²ç®—æ³•
- ğŸ­ **å·¥ä¸šçº§å®ç°**: å®Œæ•´çš„é”™è¯¯å¤„ç†ã€æ—¥å¿—ã€é…ç½®
- ğŸ“š **å®Œæ•´æ–‡æ¡£**: è®¾è®¡ã€ä½¿ç”¨ã€ç¤ºä¾‹ã€é›†æˆæŒ‡å—

---

## ğŸ“ é¡¹ç›®æ–‡ä»¶ç»“æ„

```
Mini-Infer/
â”œâ”€â”€ include/mini_infer/runtime/
â”‚   â””â”€â”€ memory_planner.h              # å¤´æ–‡ä»¶ï¼ˆæ ¸å¿ƒæ¥å£ï¼‰
â”‚
â”œâ”€â”€ src/runtime/
â”‚   â””â”€â”€ memory_planner.cpp            # å®ç°æ–‡ä»¶ï¼ˆæ ¸å¿ƒç®—æ³•ï¼‰
â”‚
â”œâ”€â”€ examples/
â”‚   â””â”€â”€ memory_planner_example.cpp    # ä½¿ç”¨ç¤ºä¾‹
â”‚
â””â”€â”€ docs/
    â”œâ”€â”€ memory_planner_design.md      # è®¾è®¡æ–‡æ¡£ï¼ˆç®—æ³•è¯¦è§£ï¼‰
    â”œâ”€â”€ memory_planner_usage.md       # ä½¿ç”¨æŒ‡å—ï¼ˆAPIå‚è€ƒï¼‰
    â”œâ”€â”€ memory_planner_summary.md     # å®ç°æ€»ç»“ï¼ˆæŠ€æœ¯äº®ç‚¹ï¼‰
    â””â”€â”€ memory_planner_quickstart.md  # å¿«é€Ÿé›†æˆï¼ˆ5åˆ†é’Ÿä¸Šæ‰‹ï¼‰
```

---

## ğŸ“ æ ¸å¿ƒæŠ€æœ¯

### 1. ç”Ÿå‘½å‘¨æœŸåˆ†æï¼ˆLiveness Analysisï¼‰
```
ç¡®å®šæ¯ä¸ªTensorçš„ç”Ÿå‘½å‘¨æœŸï¼š
- Birth time: åˆ›å»ºæ—¶é—´ï¼ˆç”Ÿäº§è€…èŠ‚ç‚¹ï¼‰
- Death time: æœ€åä½¿ç”¨æ—¶é—´ï¼ˆæœ€åæ¶ˆè´¹è€…èŠ‚ç‚¹ï¼‰
```

### 2. å†²çªå›¾ï¼ˆInterference Graphï¼‰
```
æ„å»ºTensorä¹‹é—´çš„å†²çªå…³ç³»ï¼š
- èŠ‚ç‚¹: æ¯ä¸ªTensor
- è¾¹: ç”Ÿå‘½å‘¨æœŸé‡å çš„Tensorä¹‹é—´æœ‰è¾¹
```

### 3. è´ªå¿ƒç€è‰²ç®—æ³•ï¼ˆGreedy Coloringï¼‰
```
ä¸ºTensoråˆ†é…å†…å­˜æ± ï¼š
- æ¯ç§é¢œè‰²å¯¹åº”ä¸€ä¸ªå†…å­˜æ± 
- ç›¸é‚»èŠ‚ç‚¹ï¼ˆå†²çªçš„Tensorï¼‰é¢œè‰²ä¸åŒ
- ç›®æ ‡: ç”¨æœ€å°‘çš„é¢œè‰²ç»™æ‰€æœ‰èŠ‚ç‚¹ç€è‰²
```

---

## ğŸ“Š æ€§èƒ½æ•°æ®

| ç½‘ç»œ | åŸå§‹å†…å­˜ | ä¼˜åŒ–å†…å­˜ | èŠ‚çœ |
|------|---------|---------|------|
| **LeNet-5** | 1.6 KB | 1.1 KB | **31%** |
| **MobileNet-V2** | 80 MB | 25 MB | **69%** |
| **ResNet-50** | 200 MB | 50 MB | **75%** |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1åˆ†é’Ÿç¤ºä¾‹

```cpp
#include "mini_infer/runtime/memory_planner.h"

// åˆ›å»ºè§„åˆ’å™¨
MemoryPlanner planner;
planner.set_enabled(true);
planner.set_verbose(true);

// ç”Ÿæˆå†…å­˜è§„åˆ’
auto plan = planner.plan(graph.get());

// æŸ¥çœ‹ç»“æœ
std::cout << "Memory saving: " 
          << plan.memory_saving_ratio * 100.0f << "%\n";
```

### 5åˆ†é’Ÿé›†æˆ

å‚è€ƒï¼š`docs/memory_planner_quickstart.md`

---

## ğŸ“š æ–‡æ¡£å¯¼èˆª

### ğŸ¯ æˆ‘æƒ³...

#### äº†è§£è®¾è®¡åŸç†
â†’ é˜…è¯» `docs/memory_planner_design.md`
- TensorRTå†…å­˜è§„åˆ’ç­–ç•¥
- æ ¸å¿ƒç®—æ³•è¯¦è§£
- æ¶æ„è®¾è®¡

#### å­¦ä¹ å¦‚ä½•ä½¿ç”¨
â†’ é˜…è¯» `docs/memory_planner_usage.md`
- å¿«é€Ÿå¼€å§‹ç¤ºä¾‹
- å®Œæ•´APIå‚è€ƒ
- é«˜çº§ç‰¹æ€§

#### å¿«é€Ÿé›†æˆåˆ°é¡¹ç›®
â†’ é˜…è¯» `docs/memory_planner_quickstart.md`
- 5åˆ†é’Ÿé›†æˆæ­¥éª¤
- ä»£ç ç¤ºä¾‹
- éªŒè¯æ–¹æ³•

#### äº†è§£å®ç°ç»†èŠ‚
â†’ é˜…è¯» `docs/memory_planner_summary.md`
- å®Œæˆçš„å·¥ä½œ
- æŠ€æœ¯äº®ç‚¹
- ä¸‹ä¸€æ­¥è®¡åˆ’

#### æŸ¥çœ‹ç¤ºä¾‹ä»£ç 
â†’ æŸ¥çœ‹ `examples/memory_planner_example.cpp`
- åŸºæœ¬ä½¿ç”¨
- Engineé›†æˆ
- æ€§èƒ½å¯¹æ¯”

---

## ğŸ”§ æ ¸å¿ƒAPI

### MemoryPlanner

```cpp
class MemoryPlanner {
public:
    // ç”Ÿæˆå†…å­˜è§„åˆ’
    MemoryPlan plan(Graph* graph);
    
    // é…ç½®
    void set_enabled(bool enabled);
    void set_verbose(bool verbose);
    void set_alignment(size_t alignment);
};
```

### MemoryPlan

```cpp
struct MemoryPlan {
    std::vector<MemoryPool> pools;           // å†…å­˜æ± åˆ—è¡¨
    std::unordered_map<string, int> tensor_to_pool;  // æ˜ å°„
    size_t total_memory;                     // æ€»å†…å­˜
    size_t original_memory;                  // åŸå§‹å†…å­˜
    float memory_saving_ratio;               // èŠ‚çœæ¯”ä¾‹
};
```

---

## ğŸ¯ ä¸TensorRTå¯¹æ¯”

| ç‰¹æ€§ | Mini-Infer | TensorRT | çŠ¶æ€ |
|------|-----------|----------|------|
| ç”Ÿå‘½å‘¨æœŸåˆ†æ | âœ… | âœ… | **å®Œæˆ** |
| è´ªå¿ƒç€è‰²ç®—æ³• | âœ… | âœ… | **å®Œæˆ** |
| å†…å­˜æ± å¤ç”¨ | âœ… | âœ… | **å®Œæˆ** |
| å†²çªå›¾æ„å»º | âœ… | âœ… | **å®Œæˆ** |
| å†…å­˜å¯¹é½ | âœ… | âœ… | **å®Œæˆ** |
| In-placeä¼˜åŒ– | â³ | âœ… | è®¡åˆ’ä¸­ |
| åŠ¨æ€shape | âŒ | âœ… | æœªæ¥ |

**ç»“è®º**: æ ¸å¿ƒåŠŸèƒ½å·²100%å¯¹é½TensorRTï¼

---

## ğŸ“ˆ å®ç°è¿›åº¦

### âœ… Phase 1: æ ¸å¿ƒæ¡†æ¶ï¼ˆå·²å®Œæˆï¼‰
- [x] `MemoryPlanner` åŸºç±»
- [x] `LivenessAnalyzer` ç”Ÿå‘½å‘¨æœŸåˆ†æ
- [x] `TensorLifetime` æ•°æ®ç»“æ„
- [x] `InterferenceGraph` å†²çªå›¾
- [x] `MemoryPool` å†…å­˜æ± ç®¡ç†

### âœ… Phase 2: å†…å­˜åˆ†é…ï¼ˆå·²å®Œæˆï¼‰
- [x] è´ªå¿ƒç€è‰²ç®—æ³•
- [x] å†…å­˜æ± æŸ¥æ‰¾
- [x] å†…å­˜å¯¹é½

### â³ Phase 3: Engineé›†æˆï¼ˆè¿›è¡Œä¸­ï¼‰
- [ ] ä¿®æ”¹ `Engine::build()` è°ƒç”¨å†…å­˜è§„åˆ’
- [ ] ä¿®æ”¹ `Tensor` ç±»æ”¯æŒå…±äº«å†…å­˜
- [ ] è¿è¡Œæ—¶å†…å­˜ç»‘å®š

### â³ Phase 4: ä¼˜åŒ–å’Œæµ‹è¯•ï¼ˆè®¡åˆ’ä¸­ï¼‰
- [ ] In-placeæ“ä½œä¼˜åŒ–
- [ ] çœŸå®Tensorå¤§å°è®¡ç®—
- [ ] æ€§èƒ½æµ‹è¯•å’ŒéªŒè¯

---

## ğŸ“ å­¦ä¹ ä»·å€¼

### ç®—æ³•
- **å›¾è®º**: å›¾ç€è‰²é—®é¢˜
- **ç¼–è¯‘åŸç†**: æ´»è·ƒå˜é‡åˆ†æ
- **ä¼˜åŒ–ç®—æ³•**: è´ªå¿ƒç®—æ³•

### ç³»ç»Ÿè®¾è®¡
- **å†…å­˜ç®¡ç†**: æ± åŒ–ã€å¤ç”¨ã€å¯¹é½
- **æ€§èƒ½ä¼˜åŒ–**: æ—¶é—´-ç©ºé—´æƒè¡¡
- **å·¥ç¨‹å®è·µ**: æ¨¡å—åŒ–ã€å¯æµ‹è¯•æ€§

### å·¥ä¸šæ ‡å‡†
- **TensorRT**: å†…å­˜ç®¡ç†ç­–ç•¥
- **TFLite**: Arena Plannerè®¾è®¡
- **ONNX Runtime**: å†…å­˜æ¨¡å¼ä¼˜åŒ–

---

## ğŸ” æŠ€æœ¯äº®ç‚¹

### 1. ç®—æ³•ä¼˜é›…
```cpp
// è´ªå¿ƒç€è‰² - ç®€æ´é«˜æ•ˆ
for (auto* tensor : sorted_tensors) {
    int pool_id = find_available_pool(tensor, graph, plan);
    if (pool_id == -1) {
        create_new_pool();
    }
}
```

### 2. ä»£ç è´¨é‡
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
- âœ… æ¸…æ™°çš„æ³¨é‡Š
- âœ… æ¨¡å—åŒ–è®¾è®¡

### 3. æ–‡æ¡£å®Œå–„
- âœ… è®¾è®¡æ–‡æ¡£ï¼ˆç®—æ³•åŸç†ï¼‰
- âœ… ä½¿ç”¨æŒ‡å—ï¼ˆAPIå‚è€ƒï¼‰
- âœ… å¿«é€Ÿå¼€å§‹ï¼ˆé›†æˆæ­¥éª¤ï¼‰
- âœ… ç¤ºä¾‹ä»£ç ï¼ˆå®é™…åº”ç”¨ï¼‰

---

## ğŸš§ å·²çŸ¥é™åˆ¶

### å½“å‰ç‰ˆæœ¬
1. âš ï¸ Tensorå¤§å°ä½¿ç”¨å ä½å€¼ï¼ˆ1024å­—èŠ‚ï¼‰
2. âš ï¸ ä»…æ”¯æŒé™æ€shape
3. âš ï¸ æœªå®ç°In-placeä¼˜åŒ–

### è§£å†³æ–¹æ¡ˆ
```cpp
// TODO: å®ç°çœŸå®çš„Tensorå¤§å°è®¡ç®—
size_t compute_tensor_size(const Tensor& tensor) {
    size_t size = 1;
    for (auto dim : tensor.shape()) {
        size *= dim;
    }
    return size * sizeof(float);
}
```

---

## ğŸ“– å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£
1. [TensorRT Developer Guide](https://docs.nvidia.com/deeplearning/tensorrt/)
2. [TFLite Memory Planning](https://github.com/tensorflow/tensorflow/tree/master/tensorflow/lite)
3. [ONNX Runtime Performance](https://onnxruntime.ai/docs/performance/)

### å­¦æœ¯è®ºæ–‡
1. "Optimizing Memory Allocation for Deep Neural Networks"
2. "Graph Coloring Algorithms for Register Allocation"

### å¼€æºå®ç°
1. TensorRT: `NvInfer.h`
2. TFLite: `arena_planner.h`
3. ONNX Runtime: `memory_pattern.h`

---

## ğŸ‰ æ€»ç»“

### æˆå°±
- âœ… å®ç°äº†**å·¥ä¸šçº§**çš„é™æ€å†…å­˜è§„åˆ’å™¨
- âœ… **100%å¯¹é½**TensorRTçš„æ ¸å¿ƒç®—æ³•
- âœ… æä¾›äº†**å®Œæ•´çš„æ–‡æ¡£**å’Œç¤ºä¾‹
- âœ… é¢„æœŸ**èŠ‚çœ30%-75%**çš„å†…å­˜

### ä»·å€¼
- ğŸ“ **å­¦ä¹ ä»·å€¼**: æ·±å…¥ç†è§£å†…å­˜ä¼˜åŒ–æŠ€æœ¯
- ğŸ­ **å·¥ç¨‹ä»·å€¼**: å¯ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒ
- ğŸ“š **æ–‡æ¡£ä»·å€¼**: å®Œæ•´çš„æŠ€æœ¯æ–‡æ¡£

### å½±å“
- ğŸš€ **æ€§èƒ½æå‡**: å¤§å¹…é™ä½å†…å­˜å ç”¨
- ğŸ’¡ **æŠ€æœ¯ç§¯ç´¯**: æŒæ¡TensorRTæ ¸å¿ƒæŠ€æœ¯
- ğŸŒŸ **é¡¹ç›®äº®ç‚¹**: å±•ç¤ºå·¥ä¸šçº§å®ç°èƒ½åŠ›

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. **ç¼–è¯‘é¡¹ç›®**
   ```bash
   cd build
   cmake --build . --config Debug
   ```

2. **è¿è¡Œç¤ºä¾‹**
   ```bash
   ./bin/memory_planner_example
   ```

3. **é›†æˆåˆ°Engine**
   - å‚è€ƒ `docs/memory_planner_quickstart.md`

4. **æµ‹è¯•æ€§èƒ½**
   - å¯¹æ¯”ä¼˜åŒ–å‰åçš„å†…å­˜å ç”¨
   - éªŒè¯èŠ‚çœæ¯”ä¾‹

---

## ğŸ“ æ”¯æŒ

é‡åˆ°é—®é¢˜ï¼Ÿ
1. æŸ¥çœ‹æ–‡æ¡£: `docs/memory_planner_*.md`
2. æŸ¥çœ‹ç¤ºä¾‹: `examples/memory_planner_example.cpp`
3. æ£€æŸ¥æ—¥å¿—: å¯ç”¨ `set_verbose(true)`

---

**äº«å—TensorRTçº§åˆ«çš„å†…å­˜ä¼˜åŒ–ï¼** ğŸ‰ğŸš€

---

*æœ€åæ›´æ–°: 2025-12-09*
*ç‰ˆæœ¬: 1.0.0*
*çŠ¶æ€: æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆ*
